<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Premium Coins - Lucky Slot</title>
    <link rel="stylesheet" href="./src/crt.css" />
    <style>
      :root { --blue:#0b64d8; --panel:#ffffff; --text:#0f1426; }
      html, body { height: 100%; margin: 0; overflow: hidden; font-family: Segoe UI, system-ui, -apple-system, Roboto, sans-serif; }
      body { background: radial-gradient(circle at 50% -20%, #3e86ee 0%, var(--blue) 60%, #053a91 100%); }
      .wrap { min-height: 100dvh; display: grid; place-items: center; padding: 4vh 2vw; }
      .card { width: clamp(320px, 60vw, 720px); max-width: 720px; margin-left: auto; margin-right: auto;; background: var(--panel); color: var(--text); border-radius: 16px; box-shadow: 0 24px 60px rgba(0,0,0,.25); padding: clamp(18px, 4vw, 28px); text-align: center; }
      .title { margin: 0 0 6px; font-size: clamp(24px, 5.2vw, 32px); font-weight: 800; }
      .lead { margin: 0 0 16px; color: #334275; }
      .count { font-size: clamp(40px, 10vmin, 72px); font-weight: 900; letter-spacing: 2px; margin: 6px 0 2px; }
      .hint { color:#5c6a99; margin: 0 0 10px; }
      .actions { display:flex; gap:12px; justify-content:center; margin-top: 10px; }
      .btn { appearance:none; border:none; border-radius: 999px; padding: 10px 18px; font-weight:800; cursor:pointer; color:#fff; background: linear-gradient(160deg, #2f00ff, #0206d1); box-shadow: 0 12px 30px rgba(47,0,255,.35); }
      .num { display:inline-block; min-width: 2ch; text-align: center; }
    </style>
  </head>
  <body class="crt crt-bulge crt-effect">
    <div class="wrap">
      <div class="card">
        <h1 class="title">Premium Processing Payment</h1>
        <p class="lead">You can start inserting coins now.</p>
        <div class="count"><span id="coins" class="num">0</span></div>
        <p class="hint" id="status">Waiting for coin pulses?</p>
        <div class="actions">
          <button class="btn" id="confirm">Confirm</button>
        </div>
      </div>
    </div>
    <script>
      // Reuse endpoints; avoid import.meta in classic scripts (causes SyntaxError)
      const PI_WS_URL = window.PI_WS_URL || `ws://${location.hostname}:5000/ws`;
      const PI_HTTP_BASE = window.PI_HTTP_BASE || `http://${location.hostname}:5000`;

      const elCoins = document.getElementById('coins');
      const elStatus = document.getElementById('status');
      const btn = document.getElementById('confirm');

      let coinCount = 0;
      try { coinCount = parseInt(localStorage.getItem('premiumCoins') || '0', 10) || 0; } catch (_) {}
      elCoins.textContent = String(coinCount);

      let lastCoin = false;
      let lastCoinTs = 0;
      let sawExternal = false; // becomes true once any WS/HTTP state received

      function addCoinPulse(){
        const now = Date.now();
        if (now - lastCoinTs <= 250) return; // cooldown
        coinCount += 1;
        elCoins.textContent = String(coinCount);
        try { localStorage.setItem('premiumCoins', String(coinCount)); } catch(_){ }
        lastCoinTs = now;
      }
      let hasReceivedCoin = false; // Track if any coin has been received
      function handleState(s){
        if (!s) return;
        sawExternal = true;
        if (typeof s.coin === 'boolean'){
          if (s.coin && !lastCoin) {
            addCoinPulse();
            hasReceivedCoin = true; // Mark that we've received at least one coin
          }
          lastCoin = !!s.coin;
          // Update status text based on whether coins have been received
          if (hasReceivedCoin) {
            elStatus.textContent = 'Payment received. Probability upgraded';
          } else {
            elStatus.textContent = 'Waiting for coin pulses';
          }
        }
      }

      // WebSocket connect + fallback polling
      let ws;
      function connect(){
        try{
          ws = new WebSocket(PI_WS_URL);
          ws.onmessage = (e)=>{ try{ handleState(JSON.parse(e.data)); }catch(_){} };
          ws.onclose = ()=> setTimeout(connect, 1000);
        }catch(_){ setTimeout(connect, 1500); }
      }
      connect();
      async function poll(){
        try{ const r = await fetch(`${PI_HTTP_BASE}/api/state`, {cache:'no-cache'}); if(r.ok){ handleState(await r.json()); } }catch(_){ }
      }
      setInterval(poll, 1000);

      // For testing: if no WS/HTTP state yet, Space adds a coin pulse
      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !sawExternal) {
          e.preventDefault();
          addCoinPulse();
          elStatus.textContent = 'Simulated coin via Space';
        }
      });

      btn.addEventListener('click', ()=>{
        try {
          const prev = JSON.parse(localStorage.getItem('playerInfo') || '{}');
          localStorage.setItem('playerInfo', JSON.stringify({ ...prev, premiumCoins: coinCount, ts: Date.now() }));
        } catch (_) {}
        window.location.href = './confirm.html';
      });
    </script>
  </body>
  </html>


